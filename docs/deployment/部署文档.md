# Uka图床系统部署文档

## 系统概述

Uka图床系统是一个基于Spring Boot + Vue.js的全栈图片托管系统，支持图片上传、管理、搜索和分享功能。

## 系统架构

- **后端**: Spring Boot 2.7.14 + MyBatis Plus + MySQL 8.0
- **前端**: Vue.js 3 + TypeScript + Tailwind CSS
- **数据库**: MySQL 8.0
- **存储**: 本地文件系统存储
- **部署**: 支持Docker容器化部署

## 环境要求

### 基础环境
- **Java**: JDK 8 或更高版本
- **Node.js**: 16.x 或更高版本
- **MySQL**: 8.0 或更高版本
- **Maven**: 3.6+ (用于构建后端)
- **Git**: 用于代码管理

### 系统要求
- **内存**: 最少2GB RAM
- **存储**: 至少10GB可用空间（用于图片存储）
- **网络**: 稳定的网络连接

## 部署步骤

### 1. 环境准备

#### 1.1 安装Java
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install openjdk-8-jdk

# CentOS/RHEL
sudo yum install java-1.8.0-openjdk-devel

# 验证安装
java -version
```

#### 1.2 安装Node.js
```bash
# 使用NodeSource仓库
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 1.3 安装MySQL
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server

# 启动MySQL服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation
```

#### 1.4 安装Maven
```bash
# Ubuntu/Debian
sudo apt install maven

# 验证安装
mvn --version
```

### 2. 数据库配置

#### 2.1 创建数据库
```sql
-- 登录MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE uka_image CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'uka_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON uka_image.* TO 'uka_user'@'localhost';
FLUSH PRIVILEGES;
```

#### 2.2 导入数据库结构
```bash
# 进入项目目录
cd /path/to/uka-image

# 导入初始化脚本
mysql -u root -p uka_image < sql/init.sql
```

### 3. 后端部署

#### 3.1 配置文件修改
编辑 `backend/src/main/resources/application.yml`:

```yaml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/uka_image?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root  # 修改为你的数据库用户名
    password: 123kabi  # 修改为你的数据库密码
    driver-class-name: com.mysql.cj.jdbc.Driver

app:
  upload:
    path: /var/uka-image/uploads  # 修改为你的文件存储路径
    max-file-size: 10MB
    allowed-types: jpg,jpeg,png,gif,webp,bmp
```

#### 3.2 创建上传目录
```bash
# 创建上传目录
sudo mkdir -p /var/uka-image/uploads
sudo chown -R $USER:$USER /var/uka-image/uploads
sudo chmod -R 755 /var/uka-image/uploads
```

#### 3.3 构建和运行后端
```bash
# 进入后端目录
cd backend

# 清理并编译
mvn clean compile

# 运行测试（可选）
mvn test

# 打包
mvn package -DskipTests

# 运行应用
java -jar target/uka-image-hosting-1.0.0.jar

# 或者直接使用Maven运行
mvn spring-boot:run
```

#### 3.4 后端服务验证
```bash
# 检查服务状态
curl http://localhost:8080/api/images

# 应该返回类似以下的JSON响应
# {"code":200,"message":"Success","data":{"records":[],"total":0,...}}
```

### 4. 前端部署

#### 4.1 安装依赖
```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install
```

#### 4.2 配置环境变量
创建 `.env.production` 文件：

```env
# API基础URL
VITE_API_BASE_URL=http://your-domain.com:8080/api

# 或者本地部署
VITE_API_BASE_URL=http://localhost:8080/api
```

#### 4.3 构建前端
```bash
# 开发模式运行
npm run dev

# 生产构建
npm run build
```

#### 4.4 部署到Web服务器

##### 使用Nginx部署
```bash
# 安装Nginx
sudo apt install nginx

# 复制构建文件
sudo cp -r dist/* /var/www/html/

# 配置Nginx
sudo nano /etc/nginx/sites-available/uka-image
```

Nginx配置文件内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 修改为你的域名
    root /var/www/html;
    index index.html;

    # 处理Vue Router的history模式
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 代理API请求到后端
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用站点：
```bash
sudo ln -s /etc/nginx/sites-available/uka-image /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 5. Docker部署（推荐）

#### 5.1 创建Docker Compose文件
创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: uka-mysql
    environment:
      MYSQL_ROOT_PASSWORD: 123kabi
      MYSQL_DATABASE: uka_image
      MYSQL_CHARACTER_SET_SERVER: utf8mb4
      MYSQL_COLLATION_SERVER: utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - uka-network

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: uka-backend
    ports:
      - "8080:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/uka_image?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: 123kabi
    volumes:
      - upload_data:/var/uka-image/uploads
    depends_on:
      - mysql
    networks:
      - uka-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: uka-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - uka-network

volumes:
  mysql_data:
  upload_data:

networks:
  uka-network:
    driver: bridge
```

#### 5.2 创建后端Dockerfile
创建 `backend/Dockerfile`:

```dockerfile
FROM openjdk:8-jdk-alpine

WORKDIR /app

COPY target/uka-image-hosting-1.0.0.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 5.3 创建前端Dockerfile
创建 `frontend/Dockerfile`:

```dockerfile
# 构建阶段
FROM node:18-alpine as build-stage

WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .
RUN npm run build

# 生产阶段
FROM nginx:alpine as production-stage

COPY --from=build-stage /app/dist /usr/share/nginx/html

# 复制Nginx配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

#### 5.4 创建Nginx配置
创建 `frontend/nginx.conf`:

```nginx
server {
    listen 80;
    server_name localhost;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://backend:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 5.5 启动Docker服务
```bash
# 构建并启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 6. 系统服务配置

#### 6.1 创建systemd服务文件
创建 `/etc/systemd/system/uka-image.service`:

```ini
[Unit]
Description=Uka Image Hosting Service
After=network.target mysql.service

[Service]
Type=simple
User=uka
WorkingDirectory=/opt/uka-image
ExecStart=/usr/bin/java -jar /opt/uka-image/uka-image-hosting-1.0.0.jar
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable uka-image
sudo systemctl start uka-image
sudo systemctl status uka-image
```

### 7. 安全配置

#### 7.1 防火墙配置
```bash
# Ubuntu/Debian (ufw)
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 8080/tcp  # 后端API（可选，如果使用Nginx代理则不需要）
sudo ufw enable

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --permanent --add-port=8080/tcp
sudo firewall-cmd --reload
```

#### 7.2 SSL证书配置（推荐）
```bash
# 使用Let's Encrypt
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d your-domain.com
```

### 8. 监控和维护

#### 8.1 日志管理
```bash
# 查看应用日志
tail -f /var/log/uka-image/application.log

# 查看Nginx日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# 查看系统服务日志
journalctl -u uka-image -f
```

#### 8.2 备份策略
```bash
# 数据库备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u root -p123kabi uka_image > /backup/uka_image_$DATE.sql

# 文件备份
tar -czf /backup/uploads_$DATE.tar.gz /var/uka-image/uploads/

# 设置定时任务
crontab -e
# 每天凌晨2点备份
0 2 * * * /path/to/backup-script.sh
```

#### 8.3 性能监控
```bash
# 安装监控工具
sudo apt install htop iotop nethogs

# 监控系统资源
htop

# 监控磁盘IO
iotop

# 监控网络使用
nethogs
```

### 9. 故障排除

#### 9.1 常见问题

**问题1: 数据库连接失败**
```bash
# 检查MySQL服务状态
sudo systemctl status mysql

# 检查端口是否开放
netstat -tlnp | grep 3306

# 测试数据库连接
mysql -u root -p -h localhost
```

**问题2: 文件上传失败**
```bash
# 检查上传目录权限
ls -la /var/uka-image/uploads/

# 修复权限
sudo chown -R uka:uka /var/uka-image/uploads/
sudo chmod -R 755 /var/uka-image/uploads/
```

**问题3: 前端无法访问后端API**
```bash
# 检查后端服务状态
curl http://localhost:8080/api/images

# 检查CORS配置
# 确保CorsConfig.java中包含正确的前端域名
```

#### 9.2 日志分析
```bash
# 查看应用启动日志
journalctl -u uka-image --since "1 hour ago"

# 查看错误日志
grep -i error /var/log/uka-image/application.log

# 查看访问日志
tail -f /var/log/nginx/access.log | grep -v "200"
```

### 10. 性能优化

#### 10.1 数据库优化
```sql
-- 添加索引
CREATE INDEX idx_images_created_at ON images(created_at);
CREATE INDEX idx_images_tags ON images(tags);
CREATE INDEX idx_images_status ON images(status);

-- 优化查询
EXPLAIN SELECT * FROM images WHERE tags LIKE '%nature%';
```

#### 10.2 文件存储优化
```bash
# 使用SSD存储
# 配置文件压缩
# 实现CDN加速
```

#### 10.3 缓存配置
```yaml
# 在application.yml中添加Redis缓存配置
spring:
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms
```

### 11. 扩展部署

#### 11.1 负载均衡
```nginx
upstream uka_backend {
    server 127.0.0.1:8080;
    server 127.0.0.1:8081;
    server 127.0.0.1:8082;
}

server {
    location /api/ {
        proxy_pass http://uka_backend/api/;
    }
}
```

#### 11.2 集群部署
- 使用Docker Swarm或Kubernetes
- 配置共享存储（NFS/GlusterFS）
- 实现数据库主从复制

### 12. 更新和维护

#### 12.1 应用更新
```bash
# 备份当前版本
cp uka-image-hosting-1.0.0.jar uka-image-hosting-1.0.0.jar.backup

# 停止服务
sudo systemctl stop uka-image

# 替换新版本
cp new-version.jar uka-image-hosting-1.0.0.jar

# 启动服务
sudo systemctl start uka-image

# 验证更新
curl http://localhost:8080/api/images
```

#### 12.2 数据库迁移
```bash
# 运行数据库迁移脚本
mysql -u root -p uka_image < sql/migrations/V2__Update_Schema.sql
```

## 总结

本文档提供了Uka图床系统的完整部署指南，包括环境准备、配置、部署、监控和维护等各个方面。请根据实际环境选择合适的部署方式，并定期进行备份和维护。

如有问题，请参考故障排除章节或联系技术支持。